@using Microsoft.AspNetCore.Identity;
@using System.Security.Claims;
@model IEnumerable<Aplicacion.Models.Cuidadore>

@{
    ViewData["Title"] = "Index";
}

<head>
    <link rel="stylesheet" href="~/css/opcionesMapa.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/map.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/IndexCuid.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
          integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />

    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
        integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
    
   <link
  rel="stylesheet"
  href="https://unpkg.com/leaflet-geosearch@3.0.0/dist/geosearch.css"
    
/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.css" />
  
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.3.0/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.3.0/dist/MarkerCluster.Default.css" />
</head>





 @if (User.Identity.IsAuthenticated)
   { 
        @if (User.IsInRole("Administrador"))
    {
        <div class="container-fluid">
            <div id="map"></div>

           

            <!-- Button trigger modal -->
            <button type="button" class="btn btn-primary m-3" id="cargar" data-toggle="modal" onclick="cargarCuidador()" data-target="#modalCargar">
                Publicar cuidador
            </button>

            <!-- Modal -->
            <div class="modal fade no-border" data-keyboard="false" data-backdrop="static"id="createCuidadorModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden=" true">
                <div class="modal-dialog modal-dialog-centered modal-lg"  role="document">
                    <div class="modal-content">
                        <div class="" style="height:530px;">
                            <button type="button" class="close" onclick="closeCargarCuidador()" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                           

                            <iframe class="no-border" src="https://localhost:7035/Cuidadores/Create" scrolling="no" style="height:100%;width:100%"></iframe>
                        </div>
                        
                            
                        
                        
                    </div>
                </div>
            </div>





        
        
        </div>
            @foreach (var item in Model)
            {
            <div id="@item.Id"  class="card d-none  container-fluid d-flex flex-column text-center align-self-center">



                @if (item.Foto != null)
                {
                    <div class="d-flex justify-content-center">
                        <img src="@item.Foto" class="align-self-center w-75 h-50" alt="1era img carousel">
                    </div>
                }


                    <div class="card-body text-center m-3">

                    <h5 class="card-title m-2">@item.Nombre @item.Apellido</h5>
                    <span>
                        Inicio: @item.HorarioIn   Fin: @item.HorarioOut <span />
                    <div class="d-flex justify-content-evenly">

                        
                        
                        <!-- Button trigger modal -->
                        <button type="button" class="m-1 btn btn-primary" id="modificar" data-toggle="modal" onclick="modificarCuidador()" data-target="#modalCargar">
                            Modificar
                        </button>

                        <!-- Modal -->
                        <div class="modal fade no-border" id="modificarCuidadorModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden=" true">
                            <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
                                <div class="modal-content">
                                    <div class="" style="height:530px;">
                                        <button type="button" class="close" data-dismiss="modal" onclick="closeModificarModal()" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>


                                        <iframe id="modificarFrame" class="no-border" src="https://localhost:7035/Cuidadores/Modificar/@item.Id" scrolling="no" style="height:100%;width:100%"></iframe>
                                    </div>




                                </div>
                            </div>
                        </div>
                        </div>
                        


                    

                    <button class="m-1  btn  btn-danger" id="eliminarBoton" onclick="eliminarCuidador(@item.Id)">Eliminar</button>
                        
                        
                     
                </div>
                </div>

            }

        }
        else
        {
        <div class="container-fluid">
            <div id="map"></div>
        </div>
            @foreach (var item in Model)
            {
                <div id="@item.Id" class="card d-none d-flex flex-column text-center align-self-center">



                @if (item.Foto != null)
                {
                    <div class="d-flex justify-content-center">
                        <img src="@item.Foto" class="align-self-center w-75 h-50" alt="1era img carousel">
                    </div>
                }


                    <div class="card-body text-center container-fluid">

                        <h5 class="card-title">@item.Nombre @item.Apellido</h5>

                        <span>Inicio: @item.HorarioIn   Fin: @item.HorarioOut <span/>
                    <button type="button" class="btn btn-primary" data-toggle="modal" onclick="openContactar()" data-target="#exampleModalCenter">
                        Contactar
                    </button>


                    <!-- Modal -->
                    <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="exampleModalLongTitle">Modal title</h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="closeContactarModal()">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                        <form asp-controller="Paseadores" asp-action="EnviarCorreo" method="post" id="formContacto">
                                        <div class="mb-3">
                                            <label for="remitente" class="form-label">Remitente:</label>
                                            <input type="email" class="form-control" id="remitente" name="remitente" readonly required value="@User.FindFirstValue("Email")">
                                        </div>
                                        <div class="mb-3">
                                            <label for="destinatario" class="form-label">Destinatario:</label>
                                            <input type="email" class="form-control" id="destinatario" name="destinatario" readonly required value="@item.Email">
                                        </div>
                                        <div class="mb-3">
                                            <label for="asunto" class="form-label">Asunto:</label>
                                            <input type="text" class="form-control" id="asunto" name="asunto" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="contenido" class="form-label">Contenido:</label>
                                            <textarea class="form-control" id="contenido" name="contenido" required></textarea>
                                        </div>
                                        
                                        <button type="submit" class="btn btn-primary">Enviar</button>
                                    </form>
                                </div>
                                
                            </div>
                        </div>
                    </div>
                    <!-- Modal -->






                </div>
                </div>
            }
        }

    }else
{
    <div class="container d-flex align-items-center justify-content-center">
        <img class="w-50 h-50"src="/img/AdobeStock_33953457.svg" />
       </div>
    }
    @section Scripts{
        <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
            integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
    
                    <script src="https://unpkg.com/leaflet-geosearch@3.0.0/dist/geosearch.umd.js"></script>


    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
                    
    <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.js" charset="utf-8"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.3.0/dist/leaflet.markercluster.js"></script>



<script>

      



        var mapOptions;
        var map;






        function mostrarCuidadadores() {
            let customIcon = {
                iconUrl: "https://svgsilh.com/svg/1314467-ff9800.svg",
                iconSize: [30, 30],

            }


            //let myIcon = L.divIcon();
            var markers = L.markerClusterGroup();
            let myIcon = L.icon(customIcon);
            $.ajax({
                type: "GET",
                url: 'Cuidadores/obtenerCuidadores',
                data: {},
                dataType: "json",

                success: function (response) {

                    // Looping over emloyee list and display it
                    $.each(response, function (index, cuidador) {

                        let iconOptions = {
                            title: cuidador.Nombre,
                            draggable: false,
                            icon: myIcon
                        }
                        let marker = new L.Marker([cuidador.Latitud, cuidador.Longitud], iconOptions);
                        markers.addLayer(marker);
                        marker.bindPopup(document.getElementById(cuidador.Id).innerHTML, {
                            maxWidth: "auto",
                            width: "250"
                        });
                    });
                    map.addLayer(markers);
                },
                failure: function (jqXHR, textStatus, errorThrown) {
                    alert("HTTP Status: " + jqXHR.status + "; Error Text: " + jqXHR.responseText); // Display error message
                }
            });


        }




        const options = {
            enableHighAccuracy: true,
            
            maximumAge: 0,
        };

        function configurarMapa(){
            map = new L.map('map', mapOptions);
            let layer = new L.TileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
                minZoom: 13,
                maxZoom: 16
            });
            map.addLayer(layer);
            

        }
        function success(pos) {
            const crd = pos.coords;

             mapOptions = {
                center: [crd.latitude, crd.longitude],
                zoom: 13,
                zoomControl: true
            }
            configurarMapa();
            L.control.locate().addTo(map);
            mostrarCuidadadores();
        }

        function error(err) {
             mapOptions = {
                center: [-34.8811236, -58.0117828],
                zoom: 13,
                zoomControl: true
            }
            configurarMapa();
            mostrarCuidadadores();
        }

        navigator.geolocation.getCurrentPosition(success, error, options);
        

         

        

        




                
        
        function cargarCuidador() {
            
            $("#createCuidadorModal").modal("show");
           
        }

        function modificarCuidador() {
            
            $("#modificarCuidadorModal").appendTo("body").modal("show");
            
        }

        function openContactar() {
            map.closePopup();
            
            $("#exampleModalCenter").appendTo("body").modal("show");
            
        }

        function closeContactarModal() {
            $("body>#exampleModalCenter").remove();

            $("#exampleModalCenter").modal("hide");

            $('body').removeClass('modal-open');
            $('.modal-backdrop').remove();

        }
        
        function closeModificarModal(){
            $("body>#modificarCuidadorModal").remove();
            
            $("#modificarCuidadorModal").modal("hide");
            
            $('body').removeClass('modal-open');
            $('.modal-backdrop').remove();
            
        }

        window.closeModificarMod =function(){
            var url = '@Url.Action("Index", "Cuidadores")';
            window.location.href = url;
            $("body>#modificarCuidadorModal").remove();

            $("#modificarCuidadorModal").modal("hide");

            $('body').removeClass('modal-open');
            $('.modal-backdrop').remove();
            

        }


        window.closeCargar = function () {
            $("#createCuidadorModal").modal("hide");
            location.reload();

        };

        function closeCargarCuidador(){

            $("#createCuidadorModal").modal("hide");
            
        }

    
        function eliminarCuidador(id_borrar){
                Swal.fire({
          title: '¿Está seguro?',
          text: "No hay vuelta atrás",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Borrar',
          cancelButtonText: 'Cancelar'
        }).then((result) => {
          if (result.isConfirmed) {

                    $.ajax({
                        type: "POST",
                        url: "/Cuidadores/borrarCuidador",
                        data: { id: id_borrar },
                        dataType: "json",
                        success: function (r) {
                            Swal.fire({
                                icon: 'success',

                                title: 'Eliminado',
                                text: 'El cuidador ha sido eliminado',
                                timer: 5000,
                                timerProgressBar: true
                            })
                                .then((result) => {
                                    /* Read more about handling dismissals below */
                                    if (result.dismiss === Swal.DismissReason.timer) {
                                        console.log('I was closed by the timer')
                                    }

                                    var url = '@Url.Action("Index", "Cuidadores")';
                                    window.location.href = url;
                                })

                        }
                    });
          }
        })



        }


        

        
     
    </script>
    }
